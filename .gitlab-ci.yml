stages:
  - build
  - test
  - report

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/
    - target/

# Build Stage
build:
  stage: build
  image: maven:3.9-eclipse-temurin-24
  script:
    - echo "Building the project..."
    - mvn $MAVEN_CLI_OPTS clean compile
  artifacts:
    paths:
      - target/
    expire_in: 1 hour

# Test Stage - Run Selenium Tests
test:selenium:
  stage: test
  image: maven:3.9-eclipse-temurin-24
  before_script:
    - echo "Installing Chrome and dependencies..."
    - apt-get update
    - apt-get install -y wget unzip gnupg2 software-properties-common
    # Install Chrome
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
    - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
    - apt-get update
    - apt-get install -y google-chrome-stable
    - google-chrome --version
    # Install ChromeDriver
    - wget -q https://storage.googleapis.com/chrome-for-testing-public/131.0.6778.87/linux64/chromedriver-linux64.zip
    - unzip -o chromedriver-linux64.zip
    - mv chromedriver-linux64/chromedriver /usr/local/bin/
    - chmod +x /usr/local/bin/chromedriver
    - chromedriver --version
  script:
    - echo "Running Selenium tests..."
    - mvn $MAVEN_CLI_OPTS clean test -Dbrowser=CHROME -Dheadless=true
  after_script:
    - echo "Tests completed!"
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
      - target/allure-results/
      - Screenshots/
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    expire_in: 7 days
  allow_failure: false

# Test Stage - Run Cucumber Tests
test:cucumber:
  stage: test
  image: maven:3.9-eclipse-temurin-24
  before_script:
    - echo "Installing Chrome and dependencies..."
    - apt-get update
    - apt-get install -y wget unzip gnupg2 software-properties-properties-common
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
    - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
    - apt-get update
    - apt-get install -y google-chrome-stable
    - google-chrome --version
    # Install ChromeDriver
    - wget -q https://storage.googleapis.com/chrome-for-testing-public/131.0.6778.87/linux64/chromedriver-linux64.zip
    - unzip -o chromedriver-linux64.zip
    - mv chromedriver-linux64/chromedriver /usr/local/bin/
    - chmod +x /usr/local/bin/chromedriver
  script:
    - echo "Running Cucumber BDD tests..."
    - mvn $MAVEN_CLI_OPTS test -Dtest=cucumber.TestRunner -Dbrowser=CHROME -Dheadless=true
  artifacts:
    when: always
    paths:
      - target/cucumber-reports.html
      - target/allure-results/
    expire_in: 7 days
  allow_failure: true

# Report Stage - Generate Allure Report
report:allure:
  stage: report
  image: maven:3.9-eclipse-temurin-24
  before_script:
    - echo "Installing Allure..."
    - apt-get update && apt-get install -y wget
    - wget -q https://github.com/allure-framework/allure2/releases/download/2.30.0/allure-2.30.0.tgz
    - tar -zxvf allure-2.30.0.tgz -C /opt/
    - ln -s /opt/allure-2.30.0/bin/allure /usr/bin/allure
    - allure --version
  script:
    - echo "Generating Allure report..."
    - allure generate target/allure-results --clean -o target/allure-report
  artifacts:
    paths:
      - target/allure-report/
    expire_in: 30 days
  dependencies:
    - test:selenium
    - test:cucumber